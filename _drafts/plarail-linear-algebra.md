---
layout: math
title:  "プラレール線型代数"
---

この記事は[夏合宿](http://blog.cybozu.io/entry/2017/08/30/080000)における @akamah の成果を寒くなった頃にまとめたものです．


## 概要
本記事では，プラレールを線型代数的な視点から眺めることによって，
レイアウトの理解，特に曲線レールに対する解釈を試みます．

## レールのベクトル
プラレールには様々なレールがあります．代表的なレールは直線レールと曲線レールです．
直線レールの長さを1とすると，曲線レールは半径が長さ1の円周の8分の1の円弧です．

（1. 画像があるといい）

線型代数的な解釈ということで，*レールの持つベクトル*というものを考えてみます．
これはレールの片方を原点として，もう片方へ向かうベクトルとします．

（2. 図，あからさまな平面に縦横にレールが置いてある）

さっそくベクトルの合成を考えます．
レールの持つベクトルを合成するときは，実際のレールに必要な「ちゃんと向きが合っている」という条件を無視することにします．
すなわち，位置さえ正確に合っていればレールをつないで伸ばせる，と都合よく考えます．
この仮定はレールをベクトルとして考えるためのやや人為的なもので，
例えば以下のような連結もベクトルとして考える場合はちょっと許してしまおうということです [^jmitani]．

（3. 図，やばい連結）

さてさて，曲線レールのベクトルも描いてみましょう．すると不思議なこと（？）が起こります．

（4. 図）

原点から伸びた先の点はどういった座標になるでしょうか？計算してみます．

（5. 図，円を描いて中心との線とか補助線をピッと引いてみる）

$$ (x, y) = (1 - 1 / \sqrt{2}, 1 / \sqrt{2}) $$

平方根が出てきました．でも平方根ってちょっとめんどくさいですね．
もうすこし分かりやすく曲線レールの持つベクトルを表せないでしょうか．

## 曲線レール
ところで，単位円の中心から周への距離は等しく長さ1であり，曲線レールは8分の1の円弧です．
そこで，端っこを無理やりくっつけることで，
次のように，**2つの直線の連結**だと捉えることもできます．

（図）

すると，曲線レールのベクトルは，**タテまたはヨコ方向**と**ななめ方向**の長さ1のベクトルを連結したものと言えます．
すなわち，ベクトルとして考えることによって曲線レールを直線2つだと捉えることができるようになりました．

## レールのベクトル表現
すると直線レールおよび曲線レールのベクトルをまとめて表す方法がひとつ思いつきます．
タテヨコななめ方向のベクトルを**整数倍**して足し合わせてベクトル空間のようなものを作る方法です (注 [^vecspace])．

まず，$$ \boldsymbol{x} $$ と $$ \boldsymbol{y} $$をxy平面の標準基底とします．
そして，以下のように基底ベクトルを取ります．

$$
\begin{align}
\boldsymbol{a} &= \boldsymbol{x} \\
\boldsymbol{b} &= \frac{\boldsymbol{x} + \boldsymbol{y}}{\sqrt{2}} \\
\boldsymbol{c} &= \boldsymbol{y} \\
\boldsymbol{b} &= \frac{-\boldsymbol{x} + \boldsymbol{y}}{\sqrt{2}} \\
\end{align}
$$

そしてこれらの4つの基底ベクトルの**整数**線形結合でレール上の座標系を表します．

(図，a, b, c, d)

こうすると，例えば横に伸びる直線レールのベクトルはx軸方向に長さ1のレールなので， $$(a, b, c, d) = (1, 0, 0, 0) $$,
原点から南（y軸の負の方向）に向かって置いた直線レールのベクトルは $$(a, b, c, d) = (0, 0, -1, 0)$$ のように表されます．

（以後，ベクトルは単に数字を4つ並べて書くものとします）

問題の曲線レールですが，原点からy軸方向に沿って置いた場合のベクトルは $$(1, 0, 0, 1)$$ となります．

（図）

ベクトル表現を用いる利点は，曲線レールがたくさん使われるレイアウトでは，
曲線をななめ方向の成分として考えることができる点です．

## れいの法則
ベクトル表現を用いて *れいの法則* [^lay]と呼ばれる法則を確認してみようと思います．
れいの法則とは，以下の2通りのレールが同じ地点にたどり着くという法則です．

（図）

まず左側から確認します．6本のレールのベクトルを下から順に足し合わせると，こうなります．

$$
\begin{align}
& (0, 0, 1, 0) +
(0, 0, 1, 0) +
(1, 0, 0, 1) +
(0, 0, 1, -1) +
(0, 1, -1, 0) +
(0, 1, -1, 0) \\
= \ & (1, 2, 1, 0)
\end{align}
$$

続いて右側はこうなります．

$$
\begin{align}
& (1, 0, 0, 1) +
(0, 1, 0, 0) +
(0, 1, 0, 0) +
(0, 0, 1, -1) \\
= \ & (1, 2, 1, 0)
\end{align}
$$

2つのレールのベクトルが一致しました．やったね！

この計算では律儀にすべてのレールのベクトルを足して計算していましたが，
現実のよく扱うレイアウトではななめ方向はそこまで多く出てこなく（たぶん），
縦横方向はわりと合わせやすいため，
ななめ方向の成分だけをカウントすることにすれば暗算も簡単です．

このように，ベクトル表現を使わずにきっちり計算していたならば，
$$ 1 / \sqrt{2} $$がたくさん出てきて大変になっていたところを，
曲線レールはななめ方向の成分を持つ，
という風にベクトル表現で考えるとちょっと楽になることがあります．

## パズル
以上の考え方を使って，三谷先生の[レールパズル](http://mitani.cs.tsukuba.ac.jp/ja/software/railway_puzzle/index.html) を解いてみようと思います．
挑戦するのは問題番号40番です．

特徴的なのは，S字に6本の曲線レールがつながっていることでしょうか．
この完成途中のレイアウトは，縦横方向のほかに左下方向に長さ6の成分を含んでいます．

つまり，右上方向の成分を持つレールを6つつなげて打ち消しつつ，縦横を合わせれば原点に戻ってこれそうです．

使えるレールは13本，うち6本は向きを合わせるため反時計回りの曲線レールに充てます，
そして残りのうち6本は右上の成分を持つレールをつなげるので，残りの1本は縦か横につなぎます．

また，基本的に曲線レール用いてななめの成分を作るときは，2本使ってS字レールの単位で作ります．
これはS字レールは端点の向きを変えないため，扱いが楽であるという理由からです．

この問題の場合は，ななめに直線レールを敷く時も2本単位で考えれば良さそうです．

さて，右上方向の成分を2つ持つレールの組み合わせは次の3種類になります．

- 
-
-

これらの組み合わせを使ったら繋がりそうです，早速やってみましょう．
ちょっと左に1回行って回りつつS字をはさんで直線を2本っと.....あれ？

も，もう一回やってみましょう，今度は直線を上方向のS字にしてみます．

む，ななめ方向は完全に解消したのにつながらない，でもこれなら途中の横方向を縦に直せば繋がりそうです．

はい，完成です！ななめの成分を考えることで，使うレールの選択肢を狭めて効率的にパズルを解けました．

## 回転の話
ベクトルの話に戻りますが，今回紹介した座標系を使うと，回転操作がすごく簡単にできます．
せっかく線型代数ぽいことをしたので，線型写像っぽく[^linmap] 45度回転を表してみます．

4つの基底を考えると，$$\boldsymbol{a}$$ を $$\boldsymbol{b}$$ に写し，
$$\boldsymbol{b}$$ を $$\boldsymbol{c}$$ に写し，
$$\boldsymbol{c}$$ を $$\boldsymbol{d}$$ に写し，
$$\boldsymbol{d}$$ を $$-\boldsymbol{a}$$ に写せばよいので，行列として書けばこうなります．

$$
\begin{align}
\mathrm{R}_{45^{\circ}} =
 \begin{pmatrix} 
 0 & 0 & 0 & -1 \\
 1 & 0 & 0 & 0 \\
 0 & 1 & 0 & 0 \\
 0 & 0 & 1 & 0
 \end{pmatrix}
\end{align}
$$

[^jmitani]: 補足しますと，[三谷先生の結果](https://twitter.com/jmitani/status/864846261517656064) より，レールのはじっこの位置を変えずに向きを変えることはできるため，方向についてはひとまず考えなくてもよいことになります．
[^lay]: 原典が見当たりませんでしたが，こちらの議論で確認しました： [プラレールの組み合わせの法則議論](https://togetter.com/li/1070425)
[^vecspace]: 整数は体ではないので，厳密にはベクトル空間とは言えませんので，ベクトル空間のようなものと言い表しました．
[^linmap]: ここまで読んでいただいて申し訳ないのですが，ベクトル空間でない以上線型写像というのはよくなくて，準同型写像と言うべきですが，比喩ということでお許しいただきたく......
